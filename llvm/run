#!/bin/sh
NAME="llvm"
RELEASE="1"
VERSION="15.0.7"
SOURCES="https://github.com/llvm/llvm-project/releases/download/llvmorg-$VERSION/llvm-$VERSION.src.tar.xz;https://github.com/llvm/llvm-project/releases/download/llvmorg-$VERSION/cmake-$VERSION.src.tar.xz;https://github.com/llvm/llvm-project/releases/download/llvmorg-$VERSION/clang-$VERSION.src.tar.xz;https://github.com/llvm/llvm-project/releases/download/llvmorg-$VERSION/lld-$VERSION.src.tar.xz;https://github.com/llvm/llvm-project/releases/download/llvmorg-$VERSION/libunwind-$VERSION.src.tar.xz;https://github.com/llvm/llvm-project/releases/download/llvmorg-$VERSION/libcxx-$VERSION.src.tar.xz;https://github.com/llvm/llvm-project/releases/download/llvmorg-$VERSION/libcxxabi-$VERSION.src.tar.xz" 
SHA256SUM="4ad8b2cc8003c86d0078d15d987d84e3a739f24aae9033865c027abae93ee7a4  llvm-15.0.7.src.tar.xz;8986f29b634fdaa9862eedda78513969fe9788301c9f2d938f4c10a3e7a3e7ea  cmake-15.0.7.src.tar.xz;a6b673ef15377fb46062d164e8ddc4d05c348ff8968f015f7f4af03f51000067  clang-15.0.7.src.tar.xz;dba5c70c3fe88b3a38b9180df82fbc9d1dfd55d68f41fddd6a90f9e17f8e5df9  lld-15.0.7.src.tar.xz;406d199ae3a16add84017f40458a5e7c31f9412937fcb518715af0a0eeafbc0c  libunwind-15.0.7.src.tar.xz;8d4eaff1cb6e41439fbf3ededb46998a0a3564d66dd289f661bdd459c9277c11  libcxx-15.0.7.src.tar.xz;9b42f3951d845232e4cd58a0a9841838292dac138af19d4f8d0c08bd41004f43  libcxxabi-15.0.7.src.tar.xz"
DESCRIPTION="The LLVM Project is a collection of modular and reusable compiler and toolchain technologies."

prepare() {
    tar -xvf llvm-$VERSION.src.tar.xz
    tar -xvf cmake-$VERSION.src.tar.xz
    cd llvm-$VERSION.src || exit 1
    mv ../cmake-$VERSION.src/* cmake/
    mv cmake/Modules/* cmake/modules/
    cd ..
    tar -xvf clang-$VERSION.src.tar.xz
    tar -xvf lld-$VERSION.src.tar.xz
    tar -xvf libunwind-$VERSION.src.tar.xz
    tar -xvf libcxx-$VERSION.src.tar.xz
    tar -xvf libcxxabi-$VERSION.src.tar.xz
    mv libunwind-$VERSION.src libunwind
    mv clang-$VERSION.src clang
    mv lld-$VERSION.src lld
    mkdir runtimes
    mv libcxx-$VERSION.src runtimes/libcxx
    mv libcxxabi-$VERSION.src runtimes/libcxxabi
}

build() {
    cd llvm-$VERSION.src
    mkdir build
    cd build
    cmake -DCMAKE_BUILD_TYPE=Release \
        -DBUILD_SHARED_LIBS=1 \
        -DLLVM_ENABLE_RTTI=ON \
        -DLLVM_INSTALL_BINUTILS_SYMLINKS=ON \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DLLVM_INCLUDE_BENCHMARKS=OFF \
        -DLLVM_BINUTILS_INCDIR=/usr/include \
        -DLLVM_ENABLE_PROJECTS="lld;clang" \
        -DLLVM_ENABLE_RUNTIMES="libcxx;libcxxabi" \
        -G Ninja ..
    ninja -j$(nproc)
}

install() {    
    cd llvm-$VERSION.src/build
    DESTDIR="$ROOT" ninja install
}
